{% extends "base.html" %}
{% block content %}
<div class="dashboard-header">
    <h2>üìä Meeting Analytics Hub</h2>
    <p>Detailed breakdown of meeting efficiency, attendance, and logs.</p>
</div>

<div class="glass-panel filter-bar">
    <form id="analyticsForm" method="GET" action="{{ url_for('meeting_analytics') }}" class="analytics-form"
        style="display:flex; gap:15px; flex-wrap:wrap; align-items:flex-end;">
        <div style="flex:1;">
            <label>Department</label>
            <select name="dept">
                <option value="All">All Departments</option>
                {% for d in depts %}<option value="{{ d.name }}">{{ d.name }}</option>{% endfor %}
            </select>
        </div>
        <div style="flex:1; min-width: 120px;">
            <label>Year</label>
            <select name="year">
                <option value="">All Years</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
            </select>
        </div>
        <div style="flex:1; min-width: 160px;">
            <label>Month (Hold Ctrl to Select Multiple)</label>
            <select name="month" multiple size="4" style="height: auto; min-height: 80px;">
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>
        <div style="flex:1; min-width: 120px;">
            <label>Start Date</label>
            <input type="date" name="start_date">
        </div>
        <div style="flex:1; min-width: 120px;">
            <label>End Date</label>
            <input type="date" name="end_date">
        </div>
        <div style="display:flex; gap:10px; align-items:flex-end;">
            <button type="button" onclick="validateAndSubmit('filter')" class="submit-btn"
                style="width:auto; height:46px; margin-bottom:2px;">Filter</button>
            <button type="button" onclick="validateAndSubmit('export')" class="btn-sm"
                style="height:46px; background:white; color:#6a11cb; font-weight:bold; margin-bottom:2px; border: 1px solid #6a11cb;">üì•
                Export Excel</button>
        </div>
    </form>
</div>

<div class="kpi-grid">
    <div class="card" style="border-top:4px solid #4cc9f0;">
        <h3>Total Logs</h3>
        <p class="big-number">{{ kpi.total }}</p>
    </div>
    <div class="card" style="border-top:4px solid #f72585;">
        <h3>Efficiency</h3>
        <p class="big-number">{{ kpi.efficiency }}%</p>
    </div>
    <div class="card" style="border-top:4px solid #00e676;">
        <h3>Best Attendance</h3>
        <p class="big-number" style="font-size:1.2rem;">{{ kpi.best_att }}</p>
    </div>
</div>

<div class="grid-2">
    <div class="glass-panel">
        <h3>Logs per Department</h3><canvas id="deptChart"></canvas>
    </div>
    <div class="glass-panel">
        <h3>Absentees Trend</h3><canvas id="absentChart"></canvas>
    </div>
</div>

<div class="glass-panel" style="margin-top:20px;">
    <h3>Detailed Meeting Registry</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Dept</th>
                <th>Objective</th>
                <th>Filed By</th>
                <th style="text-align:center;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for m in meetings %}
            <tr>
                <td>{{ m.date_of_meeting }}</td>
                <td>{{ m.department }}</td>
                <td>{{ m.objective }}</td>
                <td>{{ m.submitted_by }}</td>
                <td style="display: flex; gap: 8px; justify-content: center;">
                    <button class="btn-sm" style="background:#2196f3; color:white; border:none;" onclick="showDetails(
                                '{{ m.date_of_meeting | replace('\'', '\\\'') }}', 
                                '{{ m.department | replace('\'', '\\\'') }}', 
                                '{{ m.objective | replace('\n', ' ') | replace('\'', '\\\'') }}', 
                                '{{ m.key_decisions | replace('\n', '<br>') | replace('\'', '\\\'') }}', 
                                '{{ m.action_items | replace('\n', '<br>') | replace('\'', '\\\'') }}', 
                                '{{ m.attendees | replace('\'', '\\\'') }}', 
                                '{{ m.absentees | replace('\'', '\\\'') }}', 
                                '{{ (m.productivity_reason or '') | replace('\n', ' ') | replace('\'', '\\\'') }}'
                            )">
                        üëÅÔ∏è View
                    </button>

                    {% if current_user.role == 'Admin' or (current_user.role == 'Leader' and current_user.department ==
                    m.department) %}
                    <form action="{{ url_for('delete_meeting', id=m.id) }}" method="POST"
                        onsubmit="return confirm('‚ö†Ô∏è Are you sure? This meeting log will be permanently deleted.');">
                        <button type="submit" class="btn-sm" style="background:#ff5252; color:white; border:none;">
                            üóëÔ∏è Delete
                        </button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="5">No meetings found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="meetingModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <div
        style="background:white; color:#333; padding:30px; border-radius:10px; width:600px; max-width:90%; max-height:90vh; overflow-y:auto; position:relative;">
        <span onclick="document.getElementById('meetingModal').style.display='none'"
            style="position:absolute; top:15px; right:20px; font-size:1.5rem; cursor:pointer; color:#ff5252;">&times;</span>
        <h2 id="mObjective" style="margin-top:0; color:#6a11cb;">Objective</h2>
        <p><strong>Date:</strong> <span id="mDate"></span> | <strong>Dept:</strong> <span id="mDept"></span></p>
        <hr style="border:0; border-top:1px solid #eee;">

        <h4 style="margin-bottom:5px;">üîë Key Decisions</h4>
        <div id="mDecisions" style="background:#f9f9f9; padding:10px; border-radius:5px;"></div>

        <h4 style="margin-bottom:5px;">‚úÖ Action Items</h4>
        <div id="mActions" style="background:#f9f9f9; padding:10px; border-radius:5px;"></div>

        <div class="grid-2" style="margin-top:15px;">
            <div>
                <h4>üë• Attendees</h4>
                <p id="mAttendees" style="font-size:0.9rem; color:#00e676;"></p>
            </div>
            <div>
                <h4>üö´ Absentees</h4>
                <p id="mAbsentees" style="font-size:0.9rem; color:#ff5252;"></p>
            </div>
        </div>

        <h4>üìâ Productivity Notes</h4>
        <p id="mReason" style="font-size:0.9rem;"></p>

        <button onclick="document.getElementById('meetingModal').style.display='none'" class="submit-btn"
            style="margin-top:20px;">Close</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    function validateAndSubmit(action) {
        const form = document.getElementById('analyticsForm');
        const formData = new FormData(form);
        const params = new URLSearchParams(formData);

        // AJAX Check for Data Availability
        fetch("{{ url_for('check_analytics_data') }}?" + params.toString())
            .then(response => response.json())
            .then(data => {
                if (data.count === 0) {
                    alert("No data available for the selected filters.\nPlease adjust your selection.");
                } else {
                    if (action === 'filter') {
                        form.submit();
                    } else if (action === 'export') {
                        // Redirect to export URL with params
                        window.location.href = "{{ url_for('export_analytics') }}?" + params.toString();
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while checking data availability.");
            });
    }

    function showDetails(date, dept, obj, decisions, actions, attendees, absentees, reason) {
        document.getElementById('mDate').innerText = date;
        document.getElementById('mDept').innerText = dept;
        document.getElementById('mObjective').innerText = obj;
        document.getElementById('mDecisions').innerHTML = decisions || 'None';
        document.getElementById('mActions').innerHTML = actions || 'None';
        document.getElementById('mAttendees').innerText = attendees || 'None';
        document.getElementById('mAbsentees').innerText = absentees || 'None';
        document.getElementById('mReason').innerText = reason || 'No notes.';
        document.getElementById('meetingModal').style.display = 'flex';
    }

    new Chart(document.getElementById('deptChart'), {
        type: 'bar',
        data: { labels: {{ dept_labels | tojson }}, datasets: [{ label: 'Logs', data: {{ dept_values | tojson }}, backgroundColor: '#4cc9f0' }] }
    });
    new Chart(document.getElementById('absentChart'), {
        type: 'line',
        data: { labels: {{ absent_labels | tojson }}, datasets: [{ label: 'Absentees', data: {{ absent_values | tojson }}, borderColor: '#ff5252', fill: false }] }
    });
</script>
{% endblock %}
